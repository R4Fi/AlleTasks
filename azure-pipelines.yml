name: $(Date:yyyyMMdd)$(Rev:.r)


stages:
- stage: DotnetTest
  jobs:
  - job: 'Service1'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service1/'
  - job: 'Service2'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service2/'
  - job: 'Service3'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service3'

- stage: DockerBuildAndPush
  jobs:
  - job: 'Service1'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service1/'
      - task: Docker@2
        displayName: docker build
        inputs:
          containerRegistry: 'DockerHub'
          repository: 'r4fi/alletasks'
          command: 'buildAndPush'
          Dockerfile: '**/Rafal.Bochenski.Service1.Dockerfile'
          tags: 's1-$(Build.SourceVersion)'
