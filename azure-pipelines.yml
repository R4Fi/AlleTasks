name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
    - main
pr:
- main

stages:
- stage: DotnetBuildAndTest
  jobs:
  - job: 'Service1'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'build'
          projects: 'Rafal.Bochenski.Service1/'
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service1/'

- stage: DockerBuildAndPush
  jobs:
  - job: 'Service1'
    steps:
      - checkout: self
      - task: DotNetCoreCLI@2
        inputs:
          command: 'test'
          projects: 'Rafal.Bochenski.Service1/'
      - task: Docker@2
        displayName: docker build
        inputs:
          containerRegistry: 'DockerHub'
          repository: 'r4fi/alletasks'
          command: 'buildAndPush'
          Dockerfile: '**/Rafal.Bochenski.Service1.Dockerfile'
          tags: 's1-$(Build.SourceVersion)'
